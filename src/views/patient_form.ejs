<!doctype html> 
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>
    RadOnco ‚Äî <%= mode === "edit" ? "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞" : (mode === "view" ? "–∫–∞—Ä—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞" : "–Ω–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç") %>
  </title>
  <style>
    :root {
      --bg-main: #f3f4f6;
      --bg-header: #ffffffee;
      --bg-card: #ffffffee;
      --border-subtle: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --danger: #b91c1c;
      --danger-hover: #991b1b;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 50% 30%, rgba(56,189,248,0.35), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(148,163,184,0.5), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(148,163,184,0.6), transparent 60%);
      background-color: #e5e7eb;
      margin: 0;
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: var(--bg-header);
      backdrop-filter: blur(18px);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span.logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 30%, rgba(56,189,248,0.3), transparent 65%);
    }
    header h1 span.logo-mark::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.7);
      border-top-color: transparent;
      border-left-color: transparent;
      transform: rotate(45deg);
    }
    header .muted {
      color: var(--text-muted);
      font-size: 12px;
    }
    header a {
      color: var(--accent-strong);
      text-decoration: none;
      margin-left: 16px;
      font-size: 14px;
    }
    header a:hover {
      text-decoration: underline;
    }

    main {
      padding: 20px 24px 40px;
      max-width: 980px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 20px 24px;
      box-shadow:
        0 18px 40px rgba(15,23,42,0.12),
        inset 0 0 0 1px rgba(148,163,184,0.35);
    }

    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 16px 24px;
    }
    .full {
      grid-column: 1 / 3;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    input,
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }
    textarea {
      min-height: 80px;
    }

    .actions {
      grid-column: 1 / 3;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }
    .actions-left {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #f9fafb;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(56,189,248,0.35);
    }
    .btn.secondary {
      background: transparent;
      box-shadow: none;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
    }
    .btn.secondary:hover {
      background: rgba(255,255,255,0.9);
    }
    .btn.danger {
      background: var(--danger);
      box-shadow: 0 8px 18px rgba(248,113,113,0.4);
    }
    .btn.danger:hover {
      background: var(--danger-hover);
    }
    .btn:hover {
      opacity: 0.97;
    }

    .muted {
      font-size: 12px;
      color: var(--text-muted);
    }
    .last-change {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .last-change strong {
      color: var(--accent-strong);
    }

    /* ========= –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –ø–ª–∞–Ω—à–µ—Ç ========= */
    @media (max-width: 1024px) {
      main {
        max-width: 100%;
        padding: 16px 16px 32px;
      }

      .card {
        border-radius: 16px;
        padding: 16px 16px 20px;
      }

      form {
        grid-template-columns: 1fr;   /* –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ */
        grid-gap: 14px;
      }

      .full {
        grid-column: 1 / 2;
      }

      .actions {
        grid-column: 1 / 2;
      }
    }

    /* ========= –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–π ========= */
    @media (max-width: 768px) {
      header {
        padding: 10px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      header h1 {
        font-size: 18px;
      }

      header a {
        font-size: 13px;
        margin-left: 0;
        margin-right: 12px;
      }

      main {
        padding: 12px 10px 24px;
      }

      .card {
        padding: 14px 12px 18px;
        border-radius: 14px;
      }

      form {
        grid-template-columns: 1fr;
        grid-gap: 12px;
      }

      .full {
        grid-column: 1 / 2;
      }

      .actions {
        flex-direction: column-reverse;
        align-items: stretch;
        gap: 10px;
      }

      .actions-left {
        justify-content: space-between;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .last-change {
        text-align: left;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>
        <span class="logo-mark"></span>
        RadOnco ‚Äî –∫–∞—Ä—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞
      </h1>
      <div class="muted">
        <%= mode === "edit" ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : (mode === "view" ? "–ü—Ä–æ—Å–º–æ—Ç—Ä" : "–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç") %>
      </div>
    </div>
    <div>
      <a href="/patients">‚Üê –∫ —Å–ø–∏—Å–∫—É</a>
      <a href="/logout">–í—ã—Ö–æ–¥</a>
    </div>
  </header>

  <main>
    <div class="card">
      <form method="post" action="<%= mode === 'edit'
        ? ('/patients/' + patient.id + '/edit')
        : (mode === 'view'
           ? '#'
           : '/patients/new') %>">

        <div>
          <label for="patient_id">ID –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
          <input id="patient_id" name="patient_id"
            value="<%= patient.patient_id || '' %>"
            <%= mode === "view" ? "readonly" : "required" %> />
          <div class="muted">
            –≠—Ç–æ—Ç ID –≤—Ä–∞—á –≤–≤–æ–¥–∏—Ç –≤ Telegram-–±–æ—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É.
          </div>
        </div>

        <div>
          <label for="full_name">–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
          <input id="full_name" name="full_name"
            value="<%= patient.full_name || '' %>"
            <%= mode === "view" ? "readonly" : "required" %> />
        </div>

        <div>
          <label for="birth_date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
          <input id="birth_date" name="birth_date" type="date"
            value="<%= patient.birth_date || '' %>"
            <%= mode === "view" ? "readonly" : "" %> />
        </div>

        <div>
          <label for="region">–†–µ–≥–∏–æ–Ω</label>
          <input id="region" name="region"
            value="<%= patient.region || '' %>"
            <%= mode === "view" ? "readonly" : "" %> />
        </div>

        <div class="full">
          <label for="diagnosis">–î–∏–∞–≥–Ω–æ–∑ (–æ–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π, TNM)</label>
          <input id="diagnosis" name="diagnosis"
            value="<%= patient.diagnosis || '' %>"
            <%= mode === "view" ? "readonly" : "" %> />
        </div>

        <div class="full">
          <label for="topometry">–¢–æ–ø–æ–º–µ—Ç—Ä–∏—è (–ø–ª–∞–Ω–∏—Ä—É—é—â–∞—è –ö–¢, –∑–æ–Ω–∞ –æ–±–ª—É—á–µ–Ω–∏—è)</label>
          <textarea id="topometry" name="topometry"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.topometry || '' %></textarea>
        </div>

        <div class="full">
          <label for="method_gray">–ú–µ—Ç–æ–¥–∏–∫–∞ –õ–¢ –∏ –¥–æ–∑–∞ (–ì—Ä, —Ç–µ–∫—Å—Ç–æ–º)</label>
        <textarea
          id="method_gray"
          name="method_gray"
          <%= mode === "view" ? "readonly" : "" %>><%= patient.method_gray || '' %></textarea>
        <div class="muted">
          –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Ö–µ–º—É –∏ –¥–æ–∑—É, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´IMRT 50 –ì—Ä / 25 —Ñ—Ä–∞–∫—Ü–∏–π, PTV1 50 –ì—Ä, PTV2 46 –ì—Ä¬ª.
        </div>
      </div>

        <div class="full">
          <label for="diary">–î–Ω–µ–≤–Ω–∏–∫ –∫—É—Ä—Å–∞ –õ–¢</label>
          <textarea id="diary" name="diary"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.diary || '' %></textarea>
        </div>

        <div class="full">
          <label for="complaints">–ñ–∞–ª–æ–±—ã</label>
          <textarea id="complaints" name="complaints"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.complaints || '' %></textarea>
        </div>

        <div class="full">
          <label for="prescriptions">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è (—Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è)</label>
          <textarea id="prescriptions" name="prescriptions"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.prescriptions || '' %></textarea>
        </div>

        <div class="full">
          <label for="discharge_summary">–í—ã–ø–∏—Å–∫–∞ (–∏—Ç–æ–≥ –ø–æ –∫—É—Ä—Å—É –õ–¢)</label>
          <textarea id="discharge_summary" name="discharge_summary"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.discharge_summary || '' %></textarea>
        </div>

        <div class="full">
          <label for="complications">–û—Å–ª–æ–∂–Ω–µ–Ω–∏—è (–ª—É—á–µ–≤—ã–µ —Ä–µ–∞–∫—Ü–∏–∏, —Å—Ç–µ–ø–µ–Ω–∏)</label>
          <textarea id="complications" name="complications"
            <%= mode === "view" ? "readonly" : "" %>><%= patient.complications || '' %></textarea>
        </div>

        <div>
          <label for="status">–°—Ç–∞—Ç—É—Å –∫—É—Ä—Å–∞ –õ–¢</label>
          <% const st = patient.status || "on_treatment"; %>
          <select id="status" name="status" <%= mode === "view" ? "disabled" : "" %>>
            <option value="planning"     <%= st === "planning" ? "selected" : "" %>>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
            <option value="on_treatment" <%= st === "on_treatment" ? "selected" : "" %>>–ù–∞ –ª–µ—á–µ–Ω–∏–∏</option>
            <option value="finished"     <%= st === "finished" ? "selected" : "" %>>–ó–∞–≤–µ—Ä—à—ë–Ω –∫—É—Ä—Å</option>
            <option value="follow_up"    <%= st === "follow_up" ? "selected" : "" %>>–ù–∞–±–ª—é–¥–µ–Ω–∏–µ</option>
          </select>
        </div>

        <div>
          <label>–û–±–Ω–æ–≤–ª–µ–Ω–æ</label>
          <div class="muted">
            <%= patient.updated_at || "–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è" %>
          </div>
          <% if (lastChange) { %>
            <div class="last-change">
              –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:
              <strong><%= lastChange.changed_at %></strong>
              <% if (lastChange.user_full_name || lastChange.user_login) { %>
                ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                <strong><%= lastChange.user_full_name || lastChange.user_login %></strong>
              <% } %>
              <% if (lastChange.source === "bot") { %>
                (—á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞)
              <% } else if (lastChange.source === "web-edit") { %>
                
              <% } else if (lastChange.source === "web-create") { %>
                (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã)
              <% } %>
              <% if (lastChange.field) { %>
                , –ø–æ–ª–µ: "<%= lastChange.field %>"
              <% } %>
            </div>
          <% } %>
        </div>

        <div class="actions">
          <div class="actions-left">
            <a class="btn secondary" href="/patients">‚Üê –ù–∞–∑–∞–¥</a>

            <% if (mode === "edit") { %>
              <button
                class="btn danger"
                type="submit"
                formmethod="post"
                formaction="/patients/<%= patient.id %>/delete"
                onclick="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É –ø–∞—Ü–∏–µ–Ω—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');"
              >
                üóë –£–¥–∞–ª–∏—Ç—å
              </button>
            <% } %>
          </div>

          <div>
            <% if (mode !== "view") { %>
              <button class="btn" type="submit">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            <% } %>
          </div>
        </div>

      </form>
    </div>
  </main>
</body>
</html>
